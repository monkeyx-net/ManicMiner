<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manic Miner Level Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
        }
        
        .controls {
            background: #2a2a2a;
            padding: 15px;
            border: 2px solid #00ff00;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .control-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        label {
            margin-right: 10px;
            color: #ffff00;
        }
        
        select, button, input {
            background: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
        }
        
        button:hover {
            background: #003300;
        }
        
        button:active {
            background: #006600;
        }
        
        .editor-area {
            display: flex;
            gap: 20px;
        }
        
        .canvas-container {
            background: #000;
            border: 3px solid #00ff00;
            padding: 10px;
            flex: 1;
        }
        
        canvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            cursor: crosshair;
        }
        
        .palette {
            background: #2a2a2a;
            border: 2px solid #00ff00;
            padding: 10px;
            width: 250px;
        }
        
        .palette h3 {
            color: #ffff00;
            margin-bottom: 10px;
        }
        
        .palette-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .palette-tile {
            width: 70px;
            height: 70px;
            border: 2px solid #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            text-align: center;
            padding: 2px;
            word-wrap: break-word;
        }
        
        .palette-tile:hover {
            border-color: #00ff00;
        }
        
        .palette-tile.selected {
            border: 3px solid #ffff00;
            box-shadow: 0 0 10px #ffff00;
        }
        
        .tile-info {
            background: #000;
            border: 1px solid #00ff00;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .export-area {
            margin-top: 20px;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            background: #000;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }
        
        .info {
            background: #2a2a2a;
            border: 2px solid #0088ff;
            padding: 15px;
            margin-top: 20px;
            color: #00ffff;
            border-radius: 5px;
        }
        
        .info h3 {
            color: #ffff00;
            margin-bottom: 10px;
        }
        
        .info ul {
            margin-left: 20px;
        }
        
        .info li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ® MANIC MINER LEVEL EDITOR ðŸŽ®</h1>
        
        <div class="controls">
            <div class="control-group">
                <label>Level:</label>
                <select id="levelSelect">
                    <option value="1">Level 1 - Central Cavern</option>
                    <option value="2">Level 2 - The Cold Room</option>
                    <option value="3">Level 3 - The Menagerie</option>
                    <option value="4">Level 4 - Abandoned Uranium Workings</option>
                    <option value="5">Level 5 - Eugene's Lair</option>
                    <option value="6">Level 6 - Processing Plant</option>
                    <option value="7">Level 7 - The Vat</option>
                    <option value="8">Level 8 - Miner Willy meets the Kong Beast</option>
                    <option value="9">Level 9 - Wacky Amoebatrons</option>
                    <option value="10">Level 10 - The Endorian Forest</option>
                    <option value="11">Level 11 - Attack of the Mutant Telephones</option>
                    <option value="12">Level 12 - Return of the Alien Kong Beast</option>
                    <option value="13">Level 13 - Ore Refinery</option>
                    <option value="14">Level 14 - Skylab Landing Bay</option>
                    <option value="15">Level 15 - The Bank</option>
                    <option value="16">Level 16 - The Sixteenth Cavern?</option>
                    <option value="17">Level 17 - The Warehouse</option>
                    <option value="18">Level 18 - Amoebatrons' Revenge</option>
                    <option value="19">Level 19 - Solar Power Generator</option>
                    <option value="20">Level 20 - The Final Barrier</option>
                </select>
            </div>
            
            <div class="control-group">
                <button id="clearBtn">Clear Level</button>
                <button id="fillBtn">Fill Solid</button>
                <button id="undoBtn">Undo</button>
            </div>
            
            <div class="control-group">
                <label>Brush Size:</label>
                <input type="range" id="brushSize" min="1" max="5" value="1">
                <span id="brushSizeLabel">1x1</span>
            </div>
            
            <div class="control-group">
                <button id="exportBtn">Export to C Code</button>
                <button id="copyBtn" style="display:none;">Copy to Clipboard</button>
            </div>
            
            <div class="control-group">
                <button id="loadBtn">Load from File</button>
                <button id="saveBtn">Save to File</button>
            </div>
        </div>
        
        <div class="editor-area">
            <div class="canvas-container">
                <canvas id="levelCanvas" width="800" height="400"></canvas>
            </div>
            
            <div class="palette">
                <h3>TILE PALETTE</h3>
                <div class="palette-grid" id="paletteGrid"></div>
                <div class="tile-info">
                    <div id="tileInfo">Select a tile</div>
                </div>
            </div>
        </div>
        
        <div class="export-area" id="exportArea" style="display:none;">
            <h3 style="color: #ffff00;">Exported C Code:</h3>
            <textarea id="exportText" readonly></textarea>
        </div>
        
        <div class="info">
            <h3>ðŸ“– Instructions</h3>
            <ul>
                <li><strong>Click/Drag</strong> on canvas to place tiles</li>
                <li><strong>Right-click</strong> to erase (place tile 0)</li>
                <li><strong>Select Tile</strong> from palette on the right</li>
                <li><strong>Brush Size</strong> slider changes drawing size</li>
                <li><strong>Export</strong> generates C array code to paste into levels.c</li>
                <li><strong>Grid:</strong> 32 columns Ã— 16 rows = 512 tiles</li>
            </ul>
            <h3 style="margin-top: 15px;">ðŸŽ¨ Tile Types</h3>
            <ul>
                <li><strong>0:</strong> Empty space</li>
                <li><strong>1:</strong> Conveyor left</li>
                <li><strong>2:</strong> Solid block/wall</li>
                <li><strong>3:</strong> Floor platform</li>
                <li><strong>4:</strong> Floor (alternate)</li>
                <li><strong>5:</strong> Collapsible floor</li>
                <li><strong>6:</strong> Collectible item</li>
                <li><strong>7:</strong> Harmful object</li>
                <li><strong>8:</strong> Enemy/robot</li>
                <li><strong>9:</strong> Special tile</li>
            </ul>
        </div>
    </div>

    <!-- Load external level data -->
    <script src="leveldata.js"></script>
    
    <script>
        // Tile definitions
        const TILE_TYPES = [
            { id: 0, name: 'SPACE', color: '#000000', desc: 'Empty space' },
            { id: 1, name: 'CONVEY', color: '#aa00aa', desc: 'Conveyor belt' },
            { id: 2, name: 'SOLID', color: '#00aaaa', desc: 'Solid wall' },
            { id: 3, name: 'FLOOR', color: '#00aa00', desc: 'Platform' },
            { id: 4, name: 'FLOOR2', color: '#aaaa00', desc: 'Alt platform' },
            { id: 5, name: 'COLLAPS', color: '#aa0000', desc: 'Collapse' },
            { id: 6, name: 'ITEM', color: '#ffff00', desc: 'Collectible' },
            { id: 7, name: 'HARM', color: '#ff0000', desc: 'Hazard' },
            { id: 8, name: 'ENEMY', color: '#ff00ff', desc: 'Enemy' },
            { id: 9, name: 'SPECIAL', color: '#ffffff', desc: 'Special' }
        ];

        // Initialize levelData - will be populated after DOM loads
        let levelData = null;
        let currentLevel = 0; // Index of current level (0-19)
        let selectedTile = 0;
        let brushSize = 1;
        let undoStack = [];

        // Canvas setup
        const canvas = document.getElementById('levelCanvas');
        const ctx = canvas.getContext('2d');
        const COLS = 32;
        const ROWS = 16;
        const TILE_SIZE = canvas.width / COLS;

        let isDrawing = false;

        // Initialize level data
        function initLevelData() {
            // Check if external data is loaded
            if (typeof MANIC_MINER_LEVELS !== 'undefined' && MANIC_MINER_LEVELS.length > 0) {
                console.log(`Loaded ${MANIC_MINER_LEVELS.length} levels from leveldata.js`);
                levelData = JSON.parse(JSON.stringify(MANIC_MINER_LEVELS));
                
                // Make sure we have exactly 20 levels
                while (levelData.length < 20) {
                    levelData.push(Array(512).fill(0));
                }
                if (levelData.length > 20) {
                    levelData = levelData.slice(0, 20);
                }
            } else {
                // No external data - create empty levels
                console.log('No external level data found. Creating empty levels.');
                levelData = Array(20).fill().map(() => Array(512).fill(0));
            }
            
            // Initialize the editor
            initPalette();
            drawLevel();
            console.log('Level editor initialized with', levelData.length, 'levels');
        }

        // Initialize palette
        function initPalette() {
            const grid = document.getElementById('paletteGrid');
            grid.innerHTML = ''; // Clear existing
            TILE_TYPES.forEach(tile => {
                const div = document.createElement('div');
                div.className = 'palette-tile';
                div.style.backgroundColor = tile.color;
                div.innerHTML = `${tile.id}<br>${tile.name}`;
                div.onclick = () => selectTile(tile.id);
                div.dataset.tileId = tile.id;
                grid.appendChild(div);
            });
            selectTile(0);
        }

        // Select tile
        function selectTile(tileId) {
            selectedTile = tileId;
            document.querySelectorAll('.palette-tile').forEach(el => {
                el.classList.remove('selected');
            });
            const selectedElement = document.querySelector(`[data-tile-id="${tileId}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
            }
            
            const tile = TILE_TYPES[tileId];
            document.getElementById('tileInfo').innerHTML = `
                <strong>Tile ${tile.id}:</strong> ${tile.name}<br>
                ${tile.desc}
            `;
        }

        // Draw level
        function drawLevel() {
            if (!levelData) return;
            
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const data = levelData[currentLevel];
            for (let i = 0; i < 512; i++) {
                const x = (i % COLS) * TILE_SIZE;
                const y = Math.floor(i / COLS) * TILE_SIZE;
                const tileId = data[i];
                
                if (tileId >= 0 && tileId < TILE_TYPES.length) {
                    ctx.fillStyle = TILE_TYPES[tileId].color;
                    ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                }
                
                // Grid lines
                ctx.strokeStyle = '#333333';
                ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
            }
        }

        // Get tile index from mouse position
        function getTileIndex(x, y) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = x - rect.left;
            const mouseY = y - rect.top;
            const col = Math.floor(mouseX / TILE_SIZE);
            const row = Math.floor(mouseY / TILE_SIZE);
            
            if (col < 0 || col >= COLS || row < 0 || row >= ROWS) return -1;
            return row * COLS + col;
        }

        // Place tile with brush
        function placeTile(index, tileId) {
            if (index < 0 || index >= 512) return;
            
            const col = index % COLS;
            const row = Math.floor(index / COLS);
            
            for (let by = 0; by < brushSize; by++) {
                for (let bx = 0; bx < brushSize; bx++) {
                    const newCol = col + bx;
                    const newRow = row + by;
                    if (newCol < COLS && newRow < ROWS) {
                        const newIndex = newRow * COLS + newCol;
                        levelData[currentLevel][newIndex] = tileId;
                    }
                }
            }
            
            drawLevel();
        }

        // Save to undo stack
        function saveUndo() {
            undoStack.push(JSON.parse(JSON.stringify(levelData[currentLevel])));
            if (undoStack.length > 50) undoStack.shift();
        }

        // Mouse events
        canvas.addEventListener('mousedown', (e) => {
            if (!levelData) return;
            saveUndo();
            isDrawing = true;
            const index = getTileIndex(e.clientX, e.clientY);
            const tileId = e.button === 2 ? 0 : selectedTile;
            placeTile(index, tileId);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!levelData || !isDrawing) return;
            const index = getTileIndex(e.clientX, e.clientY);
            const tileId = e.buttons === 2 ? 0 : selectedTile; // Use buttons for move
            placeTile(index, tileId);
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
        });

        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });

        // Brush size
        document.getElementById('brushSize').addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
            document.getElementById('brushSizeLabel').textContent = `${brushSize}x${brushSize}`;
        });

        // Clear level
        document.getElementById('clearBtn').addEventListener('click', () => {
            if (!levelData) return;
            if (confirm('Clear entire level?')) {
                saveUndo();
                levelData[currentLevel] = Array(512).fill(0);
                drawLevel();
            }
        });

        // Fill solid
        document.getElementById('fillBtn').addEventListener('click', () => {
            if (!levelData) return;
            if (confirm('Fill entire level with solid tiles?')) {
                saveUndo();
                levelData[currentLevel] = Array(512).fill(2);
                drawLevel();
            }
        });

        // Undo
        document.getElementById('undoBtn').addEventListener('click', () => {
            if (!levelData) return;
            if (undoStack.length > 0) {
                levelData[currentLevel] = undoStack.pop();
                drawLevel();
            }
        });

        // Export to C code
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (!levelData) return;
            const data = levelData[currentLevel];
            let output = `    { // Level ${currentLevel + 1}\n`;
            
            for (let row = 0; row < ROWS; row++) {
                output += '        ';
                for (let col = 0; col < COLS; col++) {
                    const index = row * COLS + col;
                    output += data[index];
                    if (index < 511) output += ', ';
                }
                output += '\n';
            }
            
            output += '    }';
            
            document.getElementById('exportText').value = output;
            document.getElementById('exportArea').style.display = 'block';
            document.getElementById('copyBtn').style.display = 'inline-block';
        });

        // Copy to clipboard
        document.getElementById('copyBtn').addEventListener('click', () => {
            const textarea = document.getElementById('exportText');
            textarea.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        });

        // Load external level data button
        document.getElementById('loadBtn').addEventListener('click', () => {
            // Reload the leveldata.js file
            const script = document.createElement('script');
            script.src = 'leveldata.js';
            script.onload = () => {
                if (typeof MANIC_MINER_LEVELS !== 'undefined' && MANIC_MINER_LEVELS.length > 0) {
                    levelData = JSON.parse(JSON.stringify(MANIC_MINER_LEVELS));
                    while (levelData.length < 20) {
                        levelData.push(Array(512).fill(0));
                    }
                    drawLevel();
                    alert(`Reloaded ${MANIC_MINER_LEVELS.length} levels from leveldata.js`);
                } else {
                    alert('No external level data found. Make sure leveldata.js is in the same folder.');
                }
            };
            script.onerror = () => {
                alert('Failed to load leveldata.js. File may not exist or there may be a syntax error.');
            };
            document.head.appendChild(script);
        });

        // Save level data button
        document.getElementById('saveBtn').addEventListener('click', () => {
            if (!levelData) return;
            const dataStr = "const MANIC_MINER_LEVELS = " + JSON.stringify(levelData, null, 2) + ";";
            const dataBlob = new Blob([dataStr], {type: 'text/javascript'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'leveldata_export.js';
            link.click();
            URL.revokeObjectURL(url);
        });

        // Level selection listener
        document.getElementById('levelSelect').addEventListener('change', (e) => {
            if (!levelData) return;
            const levelNum = parseInt(e.target.value); // 1-20 from dropdown
            const levelIndex = levelNum - 1; // Convert to 0-19 array index
            currentLevel = levelIndex;
            saveUndo();
            drawLevel();
        });

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initLevelData();
        });

        // Also initialize if DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLevelData);
        } else {
            initLevelData();
        }
    </script>
</body>
</html>