name: Build Manic Miner Multi-Arch

on:
  push:
    branches: [ mingw ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    branches: [ mingw ]

jobs:
  build-x86_64:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      
    - name: Checkout submodules (if any)
      run: git submodule update --init --recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          appstream \
          wget \
          fuse \
          libpipewire-0.3-dev \
          libfuse2 \
          build-essential \
          make \
          file

    - name: Build SDL library (if needed)
      run: |
        # Only build SDL if your project requires specific version/features
        if [ -f "Makefile" ] && grep -q "SDL" "Makefile"; then
          echo "Using system SDL libraries"
        else
          echo "Building custom SDL..."
          SDL_RELEASE_TAG=release-2.30.2
          git clone https://github.com/libsdl-org/SDL.git sdl-build
          cd sdl-build
          git checkout $SDL_RELEASE_TAG
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          
          # Fixed PipeWire check
          if ! grep -q "PKG_PIPEWIRE_VERSION:INTERNAL=" CMakeCache.txt; then
            echo "SDL library configured with PipeWire support"
          else
            echo "Warning: SDL library not configured with PipeWire support"
          fi
          
          make -j$(nproc)
          # Set environment variables to use custom build
          export SDL2_DIR=$(pwd)
          cd ../..
        fi

    - name: Build Manic Miner
      run: |
        make
        
    - name: Verify binary architecture
      run: |
        file manicminer
        echo "Binary built for architecture: x86_64"

    - name: Download AppImage tool
      run: |
        wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool

    - name: Package Manic Miner into AppImage
      run: |
        # Create AppDir structure
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Create desktop entry
        cat > AppDir/usr/share/applications/manicminer.desktop << EOF
        [Desktop Entry]
        Name=Manic Miner
        Exec=manicminer
        Icon=manicminer
        Type=Application
        Categories=Game;
        EOF
        
        # Copy binary
        cp manicminer AppDir/usr/bin/
        chmod +x AppDir/usr/bin/manicminer
        
        # Copy icon (assuming it exists)
        if [ -f "src/manicminer.png" ]; then
          cp src/manicminer.png AppDir/usr/share/icons/hicolor/256x256/apps/
          cp src/manicminer.png AppDir/
        fi
        
        # Copy required libraries
        cd AppDir
        ln -s usr/bin/manicminer AppRun
        ln -s usr/share/applications/manicminer.desktop manicminer.desktop
        cd ..
        
        # Copy SDL library if custom built
        if [ -f "sdl-build/build/libSDL2-2.0.so.0" ]; then
          cp sdl-build/build/libSDL2-2.0.so.0 AppDir/usr/lib/
        fi
        
        # Generate AppImage
        ./appimagetool AppDir manicminer-x86_64.AppImage

    - name: Create binary archive
      run: |
        mkdir -p dist
        cp manicminer dist/manicminer-x86_64
        tar -czf manicminer-linux-x86_64.tar.gz -C dist .

    - name: Upload x86_64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: manicminer-x86_64
        path: |
          manicminer-x86_64.AppImage
          manicminer-linux-x86_64.tar.gz
          manicminer
        retention-days: 7

  build-arm64:
    runs-on: ubuntu-latest
    steps:
    - name: Build for ARM64
      uses: uraimo/run-on-arch-action@v2
      with:
        arch: aarch64
        distro: ubuntu22.04
        githubToken: ${{ github.token }}
        # Use sudo for package installation
        setup: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            build-essential \
            make \
            file \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libpipewire-0.3-dev \
            cmake \
            pkg-config
        run: |
          # Checkout and build in the QEMU environment
          cd /home/runner/work/${{ github.event.repository.name }}/${{ github.event.repository.name }}
          
          echo "Building SDL library..."
          SDL_RELEASE_TAG=release-2.30.2
          git clone https://github.com/libsdl-org/SDL.git sdl-build
          cd sdl-build
          git checkout $SDL_RELEASE_TAG
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)
          cd ../..
          
          echo "Building Manic Miner..."
          make
          
          echo "Verifying binary architecture..."
          file manicminer
          
          echo "Creating binary distribution..."
          mkdir -p dist
          cp manicminer dist/manicminer-aarch64
          tar -czf manicminer-linux-arm64.tar.gz -C dist .
          
          # List created files
          ls -la *.tar.gz

    - name: Upload ARM64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: manicminer-arm64
        path: |
          manicminer-linux-arm64.tar.gz
        retention-days: 7

  create-release:
    needs: [build-x86_64, build-arm64]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: List downloaded artifacts
      run: |
        find artifacts -type f | sort
        echo "Creating combined release package..."
        
    - name: Create combined release archive
      run: |
        mkdir -p release
        
        # Copy all artifacts to release directory
        cp artifacts/manicminer-x86_64/manicminer-x86_64.AppImage release/
        cp artifacts/manicminer-x86_64/manicminer-linux-x86_64.tar.gz release/
        cp artifacts/manicminer-arm64/manicminer-linux-arm64.tar.gz release/
        
        # Create SHA256 checksums
        cd release
        for file in *; do
          if [ -f "$file" ]; then
            sha256sum "$file" > "$file.sha256"
          fi
        done
        
        # Create README with build info
        cat > README.txt << EOF
        Manic Miner Multi-Architecture Build
        ====================================
        
        Built from: ${{ github.sha }}
        Build date: $(date -u)
        
        Files:
        - manicminer-x86_64.AppImage: AppImage for x86_64 (Intel/AMD) systems
        - manicminer-linux-x86_64.tar.gz: Binary archive for x86_64 systems
        - manicminer-linux-arm64.tar.gz: Binary archive for ARM64 systems
        
        Verify checksums with: sha256sum -c *.sha256
        
        Notes:
        - ARM64 build is provided as a binary archive only
        - x86_64 build includes both AppImage and binary archive
        EOF
        
        # Create combined zip for easy download
        zip -r manicminer-multi-arch-release.zip *
        
    - name: Upload combined release
      uses: actions/upload-artifact@v4
      with:
        name: manicminer-combined-release
        path: release/
        retention-days: 30